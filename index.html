<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EASY MONEY</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyApcL3hN95djDhI-26L623jHHbzREswfQE",
  authDomain: "cash-1968a.firebaseapp.com",
  databaseURL: "https://cash-1968a-default-rtdb.firebaseio.com",
  projectId: "cash-1968a",
  storageBucket: "cash-1968a.appspot.com",
  messagingSenderId: "234016139024",
  appId: "1:234016139024:web:f11daa0328ff06173d2795"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
window.db = db;

const tg = window.Telegram.WebApp;
tg.expand();

const uid = tg.initDataUnsafe?.user?.id;
const adminID = 7020322752;
const userRef = ref(db, "users/" + uid);

let balance = 0;
let energy = 1000;

onValue(userRef, s => {
  if (!s.exists()) {
    set(userRef, {
      balance: 0,
      energy: 1000,
      refBy: tg.initDataUnsafe?.start_param || null
    });
  } else {
    balance = s.val().balance || 0;
    energy = s.val().energy || 1000;
    document.getElementById("balance").innerText = balance.toFixed(2);
    document.getElementById("energy").innerText = energy;
  }
});

/* ---------- НАВИГАЦИЯ ---------- */
window.showPage = id => {
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

window.nav = (id, el) => {
  document.querySelectorAll(".nav img").forEach(i => i.classList.remove("active"));
  el.classList.add("active");
  showPage(id);
};

/* ---------- КЛИКЕР ---------- */
window.tap = () => {
  if (energy <= 0) return;
  energy--;
  balance += 0.005;
  update(userRef, { energy, balance });
};

/* ---------- ФОТО TG ---------- */
setTimeout(() => {
  const u = tg.initDataUnsafe?.user;
  if (u) {
    document.getElementById("uid").innerText = u.id;
    document.getElementById("profilePic").src =
      u.photo_url || "https://i.postimg.cc/CKZP5zZC/user.png";
    document.getElementById("refLink").innerText =
      "https://t.me/DifferentEarningsBot?start=" + u.id;
    if (u.id === adminID) document.getElementById("admin-entry").style.display = "block";
  }
}, 1000);

/* ---------- ЗАДАНИЯ ---------- */
onValue(ref(db, "tasks"), s => {
  const list = document.getElementById("task-list");
  list.innerHTML = "";
  s.forEach(c => {
    const t = c.val();
    const d = document.createElement("div");
    d.className = "card";
    d.innerHTML = `<b>${t.name}</b> <span style="float:right">${t.price}₽</span>`;
    d.onclick = () => openTask(c.key, t);
    list.appendChild(d);
  });
});

window.openTask = (id, t) => {
  window.currentTask = { id, t };
  document.getElementById("det-title").innerText = t.name;
  document.getElementById("det-desc").innerText = t.desc;
  document.getElementById("det-price").innerText = t.price;
  document.getElementById("det-link-btn").onclick = () => tg.openLink(t.link);
  showPage("task-details");
};

window.sendTaskReport = () => {
  const info = document.getElementById("det-input").value;
  if (!info) return;
  push(ref(db, "reports"), {
    uid,
    taskId: currentTask.id,
    taskName: currentTask.t.name,
    price: currentTask.t.price,
    info,
    status: "pending"
  });
  showPage("tasks");
};

/* ---------- АДМИН: ОДОБРЕНИЕ + 10% РЕФЕРАЛУ ---------- */
window.approveReport = id => {
  get(ref(db, "reports/" + id)).then(s => {
    const r = s.val();
    const uRef = ref(db, "users/" + r.uid);
    get(uRef).then(us => {
      const u = us.val();
      update(uRef, { balance: (u.balance || 0) + r.price });

      if (u.refBy) {
        const refRef = ref(db, "users/" + u.refBy);
        get(refRef).then(rs => {
          const b = (rs.val()?.balance || 0) + r.price * 0.1;
          update(refRef, { balance: +b.toFixed(2) });
        });
      }

      update(ref(db, "reports/" + id), { status: "approved" });
    });
  });
};

/* ---------- ИСТОРИЯ / СТАТУСЫ ---------- */
onValue(ref(db, "reports"), s => {
  pending.innerHTML = rejected.innerHTML = "";
  s.forEach(c => {
    const r = c.val();
    if (r.uid !== uid) return;
    const d = document.createElement("div");
    d.className = "card";
    d.innerText = r.taskName;
    if (r.status === "pending") pending.appendChild(d);
    if (r.status === "rejected") rejected.appendChild(d);
  });
});

onValue(ref(db, "logs"), s => {
  history.innerHTML = "";
  s.forEach(c => {
    const l = c.val();
    if (l.uid !== uid) return;
    const d = document.createElement("div");
    d.className = "card";
    d.innerText = `[${l.time}] ${l.msg}`;
    history.appendChild(d);
  });
});
</script>

<style>
body{margin:0;background:#111;color:#fff;font-family:Arial}
.page{display:none;padding:20px}
.page.active{display:block}
.card{background:#222;padding:15px;border-radius:14px;margin-bottom:15px}
.btn{padding:14px;width:100%;margin-top:10px}
.nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;background:#000}
.nav img{width:40px;opacity:.5}
.nav img.active{opacity:1}
</style>
</head>

<body>

<div class="page active" id="earn">
  <div class="card">
    <button class="btn" onclick="showPage('tasks')">Задания</button>
    <button class="btn" onclick="showPage('click')">Клики</button>
    <button class="btn" onclick="showPage('ref')">Рефералы</button>
  </div>
</div>

<div class="page" id="tasks"><div id="task-list"></div></div>

<div class="page" id="task-details">
  <div class="card">
    <h3 id="det-title"></h3>
    <p id="det-desc"></p>
    <p>Награда: <span id="det-price"></span>₽</p>
    <button class="btn" id="det-link-btn">Перейти</button>
    <textarea id="det-input"></textarea>
    <button class="btn" onclick="sendTaskReport()">Отправить</button>
  </div>
</div>

<div class="page" id="click">
  <p>Баланс: <span id="balance">0</span>₽</p>
  <p>Энергия: <span id="energy">1000</span></p>
  <img src="https://i.postimg.cc/cCspvTn2/Picsart-26-01-03-04-33-45-909.png" width="150" onclick="tap()">
</div>

<div class="page" id="profile">
  <img id="profilePic" width="60">
  <p>ID: <span id="uid"></span></p>
  <button class="btn" onclick="showPage('history')">История</button>
  <button class="btn" onclick="showPage('pending')">На проверке</button>
  <button class="btn" onclick="showPage('rejected')">Отклонённые</button>
</div>

<div class="page" id="history"><div id="history"></div></div>
<div class="page" id="pending"><div id="pending"></div></div>
<div class="page" id="rejected"><div id="rejected"></div></div>

<div class="page" id="ref">
  <p>+10₽ и 200 энергии за каждого</p>
  <p id="refLink"></p>
</div>

<div class="nav">
  <img src="https://i.postimg.cc/9MfvXtnQ/Picsart-26-01-03-07-41-15-897.png" onclick="nav('earn',this)" class="active">
  <img src="https://i.postimg.cc/jdGK89kw/Picsart-26-01-03-07-38-38-882.png" onclick="nav('profile',this)">
</div>

</body>
</html>
