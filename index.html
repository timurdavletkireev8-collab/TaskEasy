<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EASY MONEY</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
  import { getDatabase, ref, set, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyApcL3hN95djDhI-26L623jHHbzREswfQE",
    authDomain: "cash-1968a.firebaseapp.com",
    databaseURL: "https://cash-1968a-default-rtdb.firebaseio.com",
    projectId: "cash-1968a",
    storageBucket: "cash-1968a.appspot.com",
    messagingSenderId: "234016139024",
    appId: "1:234016139024:web:f11daa0328ff06173d2795"
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window.db = db; // Делаем базу доступной

  const tg = window.Telegram.WebApp;
  tg.expand();

  let uid = tg.initDataUnsafe?.user?.id || 0;
  let balance = 0;
  let energy = 1000;
  const userRef = ref(db, "users/" + uid);

  // Инициализация при загрузке модуля
  document.getElementById("uid").innerText = uid;
  document.getElementById("refLink").innerText = "https://t.me/DifferentEarningsBot?start=" + uid;
  document.getElementById("profilePic").src = tg.initDataUnsafe?.user?.photo_url || "";

  get(userRef).then(snapshot=>{
    if(!snapshot.exists()){
      set(userRef, {balance:0,energy:1000,referrals:0,doneTasks:0,history:[]});
    }
  });

  onValue(userRef, snapshot=>{
    const data = snapshot.val();
    if(data){
      balance = data.balance || 0;
      energy = data.energy || 1000;
      document.getElementById("balance").innerText = balance.toFixed(2);
      document.getElementById("energy").innerText = energy;
    }
  });

  // --- ГЛОБАЛЬНЫЕ ФУНКЦИИ ДЛЯ КНОПОК ---

  window.showPage = function(id) {
    document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
    const target = document.getElementById(id);
    if(target) target.classList.add("active");
  };

  window.nav = function(id, event) {
    document.querySelectorAll(".nav img").forEach(i => i.classList.remove("active"));
    showPage(id);
    if(event && event.target) {
        event.target.classList.add("active");
    }
  };

  window.tap = function() {
    if(energy <= 0) {
        alert("Энергия закончилась"); 
        return;
    }
    energy--;
    balance += 0.005;
    document.getElementById("balance").innerText = balance.toFixed(3);
    document.getElementById("energy").innerText = energy;
    update(userRef, {balance: balance, energy: energy});
  };

  window.copyRef = function() {
    const link = document.getElementById("refLink").innerText;
    navigator.clipboard.writeText(link).then(() => {
        alert("Ссылка скопирована");
    });
  };

  window.sendWithdraw = function() {
    const card = document.getElementById("card").value;
    const sum = Number(document.getElementById("sumWithdraw").value);
    if(!card || sum < 100) {
        alert("Введите корректные данные (минимум 100₽)"); 
        return;
    }
    if(sum > balance) {
        alert("Недостаточно средств");
        return;
    }
    const withdrawRef = push(ref(db, "withdrawals"));
    set(withdrawRef, {uid: uid, card: card, sum: sum, status: "pending"});
    alert("Заявка отправлена");
    showPage('profile');
  };

  window.addTask = function() {
    const name = document.getElementById("adminTaskName").value;
    const desc = document.getElementById("adminTaskDesc").value;
    const link = document.getElementById("adminTaskLink").value;
    const price = Number(document.getElementById("adminTaskPrice").value);
    if(!name || !desc || !link || !price) {
        alert("Заполните все поля"); 
        return;
    }
    const tRef = push(ref(db, "tasks"));
    set(tRef, {name, desc, link, price});
    alert("Задание добавлено");
  };

  window.tg = tg;

  // Admin Logic
  const adminID = 7020322752;
  if(uid === adminID){
    const adminDiv = document.getElementById("admin-btn-container");
    const btn = document.createElement("button");
    btn.className = "btn";
    btn.innerText = "Админка";
    btn.onclick = () => showPage('admin');
    adminDiv.appendChild(btn);

    const adminPage = document.createElement("div");
    adminPage.id = "admin";
    adminPage.className = "page";
    adminPage.innerHTML = `
      <div class="card">
        <h3>Админка</h3>
        <div>
          <h4>Добавить задание</h4>
          <input id="adminTaskName" placeholder="Название" style="width:100%; margin-bottom:5px;">
          <input id="adminTaskDesc" placeholder="Описание" style="width:100%; margin-bottom:5px;">
          <input id="adminTaskLink" placeholder="Ссылка" style="width:100%; margin-bottom:5px;">
          <input id="adminTaskPrice" placeholder="Цена" style="width:100%; margin-bottom:10px;">
          <button class="btn" onclick="addTask()">Добавить</button>
        </div>
        <button class="btn btn-red" onclick="showPage('info')">Назад</button>
      </div>`;
    document.body.appendChild(adminPage);
  }
</script>

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Arial,sans-serif;color:white;overflow:hidden;}
body{background:url("https://i.postimg.cc/2jx4fT8X/Giga-Chat-40.jpg") center/cover no-repeat;}

/* TOP */
.top{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;}
.title{font-size:22px;font-weight:900;padding:8px 14px;background:rgba(255,255,255,0.12);border:2px solid rgba(255,255,255,0.8);border-radius:16px;backdrop-filter:blur(6px);}
.balance{padding:10px 14px;background:rgba(0,0,0,0.55);border:2px solid rgba(255,255,255,0.8);border-radius:16px;cursor:pointer;}

/* PAGE */
.page{display:none;padding:20px;height:calc(100% - 150px);overflow-y:auto;}
.page.active{display:block}
.card{background:rgba(0,0,0,0.45);border:2px solid rgba(255,255,255,0.8);border-radius:22px;padding:20px;margin-bottom:20px;}
.btn{width:100%;padding:16px;margin-top:14px;font-size:16px;font-weight:600;color:white;background:rgba(0,0,0,0.5);border:2px solid rgba(255,255,255,0.8);border-radius:18px;cursor:pointer;}
.btn-red{background:rgba(255,0,0,0.35);}
input{width:100%; padding:10px; margin-top:5px; border-radius:10px; border:none;}

/* NAV */
.nav{position:fixed;bottom:0;width:100%;height:90px;background:rgba(0,0,0,0.6);display:flex;justify-content:space-around;align-items:center;}
.nav img{width:48px;height:48px;opacity:0.6;cursor:pointer;}
.nav img.active{opacity:1;}

/* CLICK */
.click-img{width:200px;height:200px;margin:30px auto;display:block;border-radius:24px;border:3px solid rgba(255,255,255,0.9); transition: transform 0.1s;}
.click-img:active{transform: scale(0.95);}
.profile-pic{width:50px;height:50px;border-radius:50%;margin-bottom:10px; background:#ddd;}
</style>
</head>
<body>

<div class="top">
  <div class="title">EASY MONEY</div>
  <div class="balance" onclick="showPage('withdraw')">
    Баланс: <span id="balance">0.00</span>₽
  </div>
</div>

<div id="earn" class="page active">
  <div class="card">
    <button class="btn" onclick="showPage('referral')">Заработок на рефералах</button>
    <button class="btn" onclick="showPage('tasks')">Заработок на заданиях</button>
    <button class="btn" onclick="showPage('click')">Заработок на кликах</button>
  </div>
</div>

<div id="referral" class="page">
  <div class="card">
    <h3>Приглашай друзей</h3>
    <p>+10₽ и 200 энергии за каждого</p>
    <p id="refLink" style="word-break: break-all; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px;"></p>
    <button class="btn" onclick="copyRef()">Скопировать</button>
    <button class="btn btn-red" onclick="showPage('earn')">Назад</button>
  </div>
</div>

<div id="tasks" class="page">
  <div class="card">
    <h3>Задания</h3>
    <div id="task-list">Пока нет доступных заданий</div>
    <button class="btn btn-red" onclick="showPage('earn')">Назад</button>
  </div>
</div>

<div id="click" class="page">
  <div class="card">
    <p>Каждый клик +0.005₽</p>
    <p>Энергия: <span id="energy">1000</span>/1000</p>
    <img class="click-img"
      src="https://i.postimg.cc/cCspvTn2/Picsart-26-01-03-04-33-45-909.png"
      onclick="tap()">
    <button class="btn btn-red" onclick="showPage('earn')">Назад</button>
  </div>
</div>

<div id="profile" class="page">
  <div class="card">
    <img id="profilePic" class="profile-pic" src="">
    <h3>Профиль</h3>
    <p>ID: <span id="uid">0</span></p>
    <div id="done-tasks-btns"></div>
    <button class="btn btn-red" onclick="showPage('withdraw')">Вывести</button>
  </div>
</div>

<div id="withdraw" class="page">
  <div class="card">
    <h3>Вывод</h3>
    <p>Укажи сумму и карту (от 100₽)</p>
    <input type="text" id="card" placeholder="Номер карты">
    <input type="number" id="sumWithdraw" placeholder="Сумма">
    <button class="btn" onclick="sendWithdraw()">Отправить</button>
    <button class="btn btn-red" onclick="showPage('profile')">Назад</button>
  </div>
</div>

<div id="info" class="page">
  <div class="card">
    <h3>Информация</h3>
    <button class="btn" onclick="window.tg.openTelegramLink('https://t.me/news')">Новости</button>
    <button class="btn" onclick="window.tg.openTelegramLink('https://t.me/sup')">Поддержка</button>
    <div id="admin-btn-container"></div>
  </div>
</div>

<div class="nav">
  <img src="https://i.postimg.cc/9MfvXtnQ/Picsart-26-01-03-07-41-15-897.png" onclick="nav('earn', event)" class="active">
  <img src="https://i.postimg.cc/jdGK89kw/Picsart-26-01-03-07-38-38-882.png" onclick="nav('profile', event)">
  <img src="https://i.postimg.cc/9fBhQfXL/Picsart-26-01-03-07-38-01-962.png" onclick="nav('info', event)">
</div>

</body>
</html>
